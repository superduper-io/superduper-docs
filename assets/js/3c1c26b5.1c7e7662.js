"use strict";(self.webpackChunknewdocs=self.webpackChunknewdocs||[]).push([[406],{6747:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>m,frontMatter:()=>l,metadata:()=>d,toc:()=>u});var a=n(4848),r=n(8453),o=n(1470),i=n(9365);const l={sidebar_label:"Multimodal vector search - Image",filename:"build.md"},s="Multimodal vector search - Image",d={id:"templates/multimodal_image_search",title:"multimodal_image_search",description:"Connect to superduper",source:"@site/content/templates/multimodal_image_search.md",sourceDirName:"templates",slug:"/templates/multimodal_image_search",permalink:"/docs/templates/multimodal_image_search",draft:!1,unlisted:!1,editUrl:"https://github.com/superduper-io/superduper/edit/main/docs/content/templates/multimodal_image_search.md",tags:[],version:"current",frontMatter:{sidebar_label:"Multimodal vector search - Image",filename:"build.md"},sidebar:"tutorialSidebar",previous:{title:"Fine tune LLM on database",permalink:"/docs/templates/llm_finetuning"},next:{title:"Multimodal vector search - Video",permalink:"/docs/templates/multimodal_video_search"}},c={},u=[{value:"Connect to superduper",id:"connect-to-superduper",level:2},{value:"Get useful sample data",id:"get-useful-sample-data",level:2},{value:"Build multimodal embedding models",id:"build-multimodal-embedding-models",level:2},{value:"Create vector-index",id:"create-vector-index",level:2},{value:"Add the data",id:"add-the-data",level:2},{value:"Perform a vector search",id:"perform-a-vector-search",level:2},{value:"Visualize Results",id:"visualize-results",level:2},{value:"Create a <code>Template</code>",id:"create-a-template",level:2}];function p(e){const t={admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.h1,{id:"multimodal-vector-search---image",children:"Multimodal vector search - Image"}),"\n",(0,a.jsx)(t.h2,{id:"connect-to-superduper",children:"Connect to superduper"}),"\n",(0,a.jsx)(t.admonition,{type:"note",children:(0,a.jsx)(t.p,{children:'Note that this is only relevant if you are running superduper in development mode.\nOtherwise refer to "Configuring your production system".'})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from superduper import superduper\n\ndb = superduper('mongomock:///test_db')\n"})}),"\n",(0,a.jsx)(t.h2,{id:"get-useful-sample-data",children:"Get useful sample data"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"!curl -O https://superduperdb-public-demo.s3.amazonaws.com/images.zip && unzip images.zip\nimport os\nfrom PIL import Image\n\ndata = [f'images/{x}' for x in os.listdir('./images') if x.endswith(\".png\")][:200]\ndata = [ Image.open(path) for path in data]\n"})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"data = [{'img': d} for d in data[:100]]\n"})}),"\n",(0,a.jsx)(t.h2,{id:"build-multimodal-embedding-models",children:"Build multimodal embedding models"}),"\n",(0,a.jsx)(t.p,{children:"We define the output data type of a model as a vector for vector transformation."}),"\n",(0,a.jsxs)(o.A,{children:[(0,a.jsx)(i.A,{value:"MongoDB",label:"MongoDB",default:!0,children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from superduper.components.vector_index import vector\noutput_datatpye = vector(shape=(1024,))        \n"})})}),(0,a.jsx)(i.A,{value:"SQL",label:"SQL",default:!0,children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from superduper.components.vector_index import sqlvector\noutput_datatpye = sqlvector(shape=(1024,))        \n"})})})]}),"\n",(0,a.jsx)(t.p,{children:"Then define two models, one for text embedding and one for image embedding."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"!pip install git+https://github.com/openai/CLIP.git\n!pip install ../../plugins/torch\nimport clip\nfrom superduper import vector\nfrom superduper_torch import TorchModel\n\n# Load the CLIP model and obtain the preprocessing function\nmodel, preprocess = clip.load(\"RN50\", device='cpu')\n\n# Create a TorchModel for text encoding\ncompatible_model = TorchModel(\n    identifier='clip_text', # Unique identifier for the model\n    object=model, # CLIP model\n    preprocess=lambda x: clip.tokenize(x)[0],  # Model input preprocessing using CLIP \n    postprocess=lambda x: x.tolist(), # Convert the model output to a list\n    datatype=output_datatpye,  # Vector encoder with shape (1024,)\n    forward_method='encode_text', # Use the 'encode_text' method for forward pass \n)\n\n# Create a TorchModel for visual encoding\nembedding_model = TorchModel(\n    identifier='clip_image',  # Unique identifier for the model\n    object=model.visual,  # Visual part of the CLIP model    \n    preprocess=preprocess, # Visual preprocessing using CLIP\n    postprocess=lambda x: x.tolist(), # Convert the output to a list \n    datatype=output_datatpye, # Vector encoder with shape (1024,)\n)\n"})}),"\n",(0,a.jsx)(t.p,{children:"Because we use multimodal models, we define different keys to specify which model to use for embedding calculations in the vector_index."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"indexing_key = 'img' # we use img key for img embedding\ncompatible_key = 'text' # we use text key for text embedding\n"})}),"\n",(0,a.jsx)(t.h2,{id:"create-vector-index",children:"Create vector-index"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"vector_index_name = 'my-vector-index'\n"})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from superduper import VectorIndex, Listener\n\nvector_index = VectorIndex(\n    vector_index_name,\n    indexing_listener=Listener(\n        key=indexing_key,                 # the `Document` key `model` should ingest to create embedding\n        select=db['docs'].select(),       # a `Select` query telling which data to search over\n        model=embedding_model,            # a `_Predictor` how to convert data to embeddings\n        identifier='indexing-listener',\n    ),\n    compatible_listener=Listener(\n        key=compatible_key,               # the `Document` key `model` should ingest to create embedding\n        model=compatible_model,           # a `_Predictor` how to convert data to embeddings\n        select=None,\n        identifier='compatible-listener',\n    )\n)\n"})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from superduper import Application\n\napplication = Application(\n    'image-vector-search',\n    components=[vector_index],\n)\n\ndb.apply(application)\n"})}),"\n",(0,a.jsx)(t.h2,{id:"add-the-data",children:"Add the data"}),"\n",(0,a.jsxs)(t.p,{children:["The order in which data is added is not important. ",(0,a.jsx)(t.em,{children:"However"})," if your data requires a custom ",(0,a.jsx)(t.code,{children:"Schema"})," in order to work, it's easier to add the ",(0,a.jsx)(t.code,{children:"Application"})," first, and the data later. The advantage of this flexibility, is that once the ",(0,a.jsx)(t.code,{children:"Application"})," is installed, it's waiting for incoming data, so that the ",(0,a.jsx)(t.code,{children:"Application"})," is always up-to-date. This comes in particular handy with AI scenarios which need to respond to changing news."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from superduper import Document\n\ntable_or_collection = db['docs']\n\nids = db.execute(table_or_collection.insert([Document(r) for r in data]))\n"})}),"\n",(0,a.jsx)(t.h2,{id:"perform-a-vector-search",children:"Perform a vector search"}),"\n",(0,a.jsx)(t.p,{children:"We can perform the vector searches using two types of data:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Text: By text description, we can find images similar to the text description."}),"\n",(0,a.jsx)(t.li,{children:"Image: By using an image, we can find images similar to the provided image."}),"\n"]}),"\n",(0,a.jsxs)(o.A,{children:[(0,a.jsx)(i.A,{value:"Text",label:"Text",default:!0,children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:'item = Document({compatible_key: "Find a black dog"})        \n'})})}),(0,a.jsx)(i.A,{value:"Image",label:"Image",default:!0,children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from IPython.display import display\nsearch_image = data[0]\ndisplay(search_image)\nitem = Document({indexing_key: search_image})        \n"})})})]}),"\n",(0,a.jsx)(t.p,{children:"Once we have this search target, we can execute a search as follows."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"select = db['docs'].like(item, vector_index=vector_index_name, n=5).select()\nresults = list(db.execute(select))\n"})}),"\n",(0,a.jsx)(t.h2,{id:"visualize-results",children:"Visualize Results"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from IPython.display import display\nfor result in results:\n    display(result[indexing_key])\n"})}),"\n",(0,a.jsxs)(t.h2,{id:"create-a-template",children:["Create a ",(0,a.jsx)(t.code,{children:"Template"})]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from superduper import Template\n\ntemplate = Template(\n    'image-vector-search',\n    template=application,\n    substitutions={'docs': 'table'},\n)\n\ntemplate.export('.')\n"})})]})}function m(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},9365:(e,t,n)=>{n.d(t,{A:()=>i});n(6540);var a=n(870);const r={tabItem:"tabItem_Ymn6"};var o=n(4848);function i(e){let{children:t,hidden:n,className:i}=e;return(0,o.jsx)("div",{role:"tabpanel",className:(0,a.A)(r.tabItem,i),hidden:n,children:t})}},1470:(e,t,n)=>{n.d(t,{A:()=>_});var a=n(6540),r=n(870),o=n(3104),i=n(6347),l=n(205),s=n(7485),d=n(1682),c=n(9466);function u(e){return a.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function p(e){const{values:t,children:n}=e;return(0,a.useMemo)((()=>{const e=t??function(e){return u(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:r}}=e;return{value:t,label:n,attributes:a,default:r}}))}(n);return function(e){const t=(0,d.X)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function m(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function h(e){let{queryString:t=!1,groupId:n}=e;const r=(0,i.W6)(),o=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,s.aZ)(o),(0,a.useCallback)((e=>{if(!o)return;const t=new URLSearchParams(r.location.search);t.set(o,e),r.replace({...r.location,search:t.toString()})}),[o,r])]}function g(e){const{defaultValue:t,queryString:n=!1,groupId:r}=e,o=p(e),[i,s]=(0,a.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!m({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:o}))),[d,u]=h({queryString:n,groupId:r}),[g,f]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[r,o]=(0,c.Dv)(n);return[r,(0,a.useCallback)((e=>{n&&o.set(e)}),[n,o])]}({groupId:r}),x=(()=>{const e=d??g;return m({value:e,tabValues:o})?e:null})();(0,l.A)((()=>{x&&s(x)}),[x]);return{selectedValue:i,selectValue:(0,a.useCallback)((e=>{if(!m({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);s(e),u(e),f(e)}),[u,f,o]),tabValues:o}}var f=n(2303);const x={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=n(4848);function v(e){let{className:t,block:n,selectedValue:a,selectValue:i,tabValues:l}=e;const s=[],{blockElementScrollPositionUntilNextRender:d}=(0,o.a_)(),c=e=>{const t=e.currentTarget,n=s.indexOf(t),r=l[n].value;r!==a&&(d(t),i(r))},u=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=s.indexOf(e.currentTarget)+1;t=s[n]??s[0];break}case"ArrowLeft":{const n=s.indexOf(e.currentTarget)-1;t=s[n]??s[s.length-1];break}}t?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":n},t),children:l.map((e=>{let{value:t,label:n,attributes:o}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:a===t?0:-1,"aria-selected":a===t,ref:e=>s.push(e),onKeyDown:u,onClick:c,...o,className:(0,r.A)("tabs__item",x.tabItem,o?.className,{"tabs__item--active":a===t}),children:n??t},t)}))})}function y(e){let{lazy:t,children:n,selectedValue:r}=e;const o=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=o.find((e=>e.props.value===r));return e?(0,a.cloneElement)(e,{className:"margin-top--md"}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:o.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==r})))})}function j(e){const t=g(e);return(0,b.jsxs)("div",{className:(0,r.A)("tabs-container",x.tabList),children:[(0,b.jsx)(v,{...e,...t}),(0,b.jsx)(y,{...e,...t})]})}function _(e){const t=(0,f.A)();return(0,b.jsx)(j,{...e,children:u(e.children)},String(t))}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>l});var a=n(6540);const r={},o=a.createContext(r);function i(e){const t=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(o.Provider,{value:t},e.children)}}}]);